<!DOCTYPE html>
<html>
  <head>
    <title>Google Sign-In</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Google Sign-in -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBnbLZ6GQgRDMurhcGAJ5KseTrFPNq3-js",
        authDomain: "airaview.firebaseapp.com",
        databaseURL: "https://airaview-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "airaview",
        storageBucket: "airaview.firebasestorage.app",
        messagingSenderId: "547164172741",
        appId: "1:547164172741:web:9ffc76f0522610d91b9bac"
      };
      firebase.initializeApp(firebaseConfig);

      // Sign-In
      function handleCredentialResponse(response) {
        firebase.auth().signInWithCredential(firebase.auth.GoogleAuthProvider.credential(response.credential))
        .then((result) => {
          const user = result.user;
          const uid = user.uid;
          const email = user.email;

          // Save to Firebase Database
          firebase.database().ref("users/" + uid).set({
            email: email,
            uid: uid
          });

          // Send back to MIT App Inventor using WebViewer.WebViewString
          window.location.href = "mitappinventor://login-success?email=" + encodeURIComponent(email) + "&uid=" + uid;
        })
        .catch((error) => {
          alert("Login Error: " + error.message);
        });
      }

      window.onload = function () {
        google.accounts.id.initialize({
          client_id: "274899310104-lvm7m5is13bihr8qfcaldlaphm01fiuc.apps.googleusercontent.com",
          callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
          document.getElementById("signinDiv"),
          { theme: "outline", size: "large" }
        );
        google.accounts.id.prompt();
      };
    </script>
  </head>
  <body>
    <h3 style="text-align:center;">Sign in with Google</h3>
    <div id="signinDiv" style="text-align:center;"></div>
  </body>
</html>
